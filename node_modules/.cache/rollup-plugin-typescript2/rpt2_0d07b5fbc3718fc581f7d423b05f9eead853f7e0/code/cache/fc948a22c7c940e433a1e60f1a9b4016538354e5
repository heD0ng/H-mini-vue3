{"code":"import { isArray, isIntegerKey } from './../../shared/src/index';\r\nimport { TriggerOpTypes } from './operations';\r\nvar activeEffect = null;\r\nvar effectList = [];\r\n/**\r\n *\r\n * @param fn\r\n * @param options : {lazy: true}-lazy为true，默认不执行\r\n * @returns\r\n */\r\nvar createReactiveEffect = function (fn, options) {\r\n    return new ReactiveEffect(fn, options);\r\n};\r\nexport var effect = function (fn, options) {\r\n    if (options === void 0) { options = {}; }\r\n    var effect = createReactiveEffect(fn, options);\r\n    if (!options.lazy) {\r\n        effect.run();\r\n    }\r\n    return effect;\r\n};\r\nvar ReactiveEffect = /** @class */ (function () {\r\n    function ReactiveEffect(fn, options) {\r\n        this.fn = fn;\r\n        this.deps = [];\r\n        this.options = options;\r\n    }\r\n    ReactiveEffect.prototype.run = function () {\r\n        // state.a++: 避免递归收集\r\n        // 当前的实例effect\r\n        if (!effectList.includes(this)) {\r\n            try {\r\n                // 入栈\r\n                activeEffect = this;\r\n                effectList.push(activeEffect);\r\n                console.log(effectList);\r\n                // cleanActiveEffectDeps(activeEffect);\r\n                return this.fn();\r\n            }\r\n            finally {\r\n                // 出栈\r\n                effectList.pop();\r\n                activeEffect = effectList[effectList.length - 1] || null;\r\n            }\r\n        }\r\n    };\r\n    return ReactiveEffect;\r\n}());\r\nfunction cleanActiveEffectDeps(activeEffect) {\r\n    var deps = activeEffect.deps;\r\n    for (var _i = 0, deps_1 = deps; _i < deps_1.length; _i++) {\r\n        var dep = deps_1[_i];\r\n        dep.delete(activeEffect);\r\n    }\r\n    activeEffect.deps.length = 0;\r\n}\r\nvar targetMap = new WeakMap();\r\nexport function track(target, key, type) {\r\n    if (!activeEffect)\r\n        return;\r\n    var depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        depsMap = new Map();\r\n        targetMap.set(target, depsMap);\r\n    }\r\n    var effectSet = depsMap.get(key);\r\n    if (!effectSet) {\r\n        effectSet = new Set();\r\n        depsMap.set(key, effectSet);\r\n    }\r\n    if (!effectSet.has(activeEffect)) {\r\n        effectSet.add(activeEffect);\r\n    }\r\n}\r\n/**\r\n *\r\n * @param target\r\n * @param key\r\n * @param type\r\n * @param value\r\n * @param oldVal\r\n * @returns\r\n * depsMap: {\r\n *  0: [e1, e2],\r\n *  length: [e2, e3]\r\n * }\r\n */\r\nexport var trigger = function (target, key, type, value, oldVal) {\r\n    if (type === void 0) { type = 'get'; }\r\n    var depsMap = targetMap.get(target);\r\n    if (!depsMap)\r\n        return;\r\n    var effectSet = depsMap.get(key);\r\n    if (effectSet) {\r\n        if (isArray(target) && key === 'length') {\r\n            // state.list.length = 1; [1,2,3] => 1 => 2、3改变了，所以需要重新触发effect\r\n            depsMap.forEach(function (val, mapKey) {\r\n                if (mapKey === 'length' || mapKey >= value) {\r\n                    val.forEach(function (cur) {\r\n                        if (cur !== activeEffect) {\r\n                            console.log(cur);\r\n                            cur.run();\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            // 深克隆\r\n            var tmp = new Set(effectSet);\r\n            switch (type) {\r\n                case TriggerOpTypes.ADD:\r\n                    // state.list[100] = 100;\r\n                    // 索引变化 => 长度变化;\r\n                    if (isArray(target) && isIntegerKey(key)) {\r\n                        depsMap.get('length').forEach(function (cur) {\r\n                            if (cur !== activeEffect) {\r\n                                console.log(cur);\r\n                                cur.run();\r\n                            }\r\n                        });\r\n                    }\r\n                    break;\r\n                case TriggerOpTypes.SET:\r\n                    // 修改值：state.list[4] = 4;\r\n                    depsMap.get(key).forEach(function (cur) {\r\n                        if (cur !== activeEffect) {\r\n                            console.log(cur);\r\n                            cur.run();\r\n                        }\r\n                    });\r\n            }\r\n        }\r\n    }\r\n    console.log(targetMap);\r\n};\r\n//# sourceMappingURL=effect.js.map","references":["D:/frontEnd/Vue3/mini-Vue3/packages/shared/src/index.ts","D:/frontEnd/Vue3/mini-Vue3/packages/reactivity/src/operations.ts"],"map":"{\"version\":3,\"file\":\"effect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../packages/reactivity/src/effect.ts\"],\"names\":[],\"mappings\":\"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\"}"}
